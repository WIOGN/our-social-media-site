let Router,multer,crypto,base64url,sharp,NormalImage,SmallImage;_43a‍.x([["default",()=>_43a‍.o]]);_43a‍.w("express",[["Router",["Router"],function(v){Router=v}]]);_43a‍.w("multer",[["default",["multer"],function(v){multer=v}]]);_43a‍.w("crypto",[["default",["crypto"],function(v){crypto=v}]]);_43a‍.w("base64url",[["default",["base64url"],function(v){base64url=v}]]);_43a‍.w("sharp",[["default",["sharp"],function(v){sharp=v}]]);_43a‍.w("../models/normal-image",[["default",["NormalImage"],function(v){NormalImage=v}]]);_43a‍.w("../models/small-image",[["default",["SmallImage"],function(v){SmallImage=v}]]);








var router = Router();

var storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, 'uploads/originals/')
    },
    filename: function (req, file, cb) {
        cb(null, file.fieldname + '-' + base64url(crypto.randomBytes(64)) + Date.now() + file.originalname)
    }
})

var upload = multer({ storage: storage });

router.post('/', upload.single('image'), async function (req, res, next) {
    // console.log(req.file);

    var smallPath = 'uploads/smalls/' + req.file.filename;

    sharp(req.file.path)
        .resize(500, 500)
        .toFile(smallPath)

    var newNormalImage = new NormalImage({
        name: req.file.filename,
        path: req.file.path
    });

    var newSmallImage = new SmallImage({
        name: req.file.filename,
        path: smallPath
    });

    try {
        var promise1 = await newNormalImage.save();
        var promise2 = await newSmallImage.save();

        if (!promise1 || !promise2) {
            throw Error('Something went wrong saving the item');
        }

        res.status(200).json(promise1)
    }
    catch (err) {
        res.status(400).json({ msg: err.message });
    }


});

_43a‍.d(router);